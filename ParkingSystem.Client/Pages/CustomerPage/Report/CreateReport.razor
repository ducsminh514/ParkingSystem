@page "/reports/create"
@using System.ComponentModel.DataAnnotations
@using ParkingSystem.Client.Services
@using ParkingSystem.Shared.Models
@inject IReportService ReportService
@inject NavigationManager Navigation
@inject UserService UserService
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3><span class="oi oi-document"></span> Create New Report</h3>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger alert-dismissible fade show">
                            <strong>Error!</strong> @errorMessage
                            <button type="button" class="close" @onclick="() => errorMessage = null">
                                <span>&times;</span>
                            </button>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <div class="alert alert-success alert-dismissible fade show">
                            <strong>Success!</strong> @successMessage
                        </div>
                    }

                    <EditForm Model="@model" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator />
                        
                        <!-- Category Selection -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <strong>Report Category</strong> <span class="text-danger">*</span>
                            </label>
                            @if (isLoadingCategories)
                            {
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2"></div>
                                    <span>Loading categories...</span>
                                </div>
                            }
                            else if (categories.Count == 0)
                            {
                                <div class="alert alert-warning">
                                    No categories available. Please contact administrator.
                                </div>
                            }
                            else
                            {
                                <InputSelect class="form-control form-control-lg" @bind-Value="model.CategoryID">
                                    <option value="">-- Select a Category --</option>
                                    @foreach (var cat in categories)
                                    {
                                        <option value="@cat.CategoryId">@cat.CategoryName</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => model.CategoryID)" class="text-danger" />
                                
                                @if (selectedCategory != null && !string.IsNullOrEmpty(selectedCategory.Description))
                                {
                                    <div class="alert alert-info mt-2 mb-0">
                                        <small><span class="oi oi-info"></span> @selectedCategory.Description</small>
                                    </div>
                                }
                            }
                        </div>

                        <!-- Priority Selection -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <strong>Priority Level</strong> <span class="text-danger">*</span>
                            </label>
                            <InputSelect class="form-control form-control-lg" @bind-Value="model.Priority">
                                <option value="Low">üü¢ Low - Minor issues</option>
                                <option value="Normal">üîµ Normal - Regular issues</option>
                                <option value="High">üü† High - Important issues</option>
                                <option value="Urgent">üî¥ Urgent - Emergency only</option>
                            </InputSelect>
                            <small class="form-text text-muted">
                                <span class="oi oi-warning"></span> Please choose priority based on issue severity
                            </small>
                        </div>

                        <!-- Title -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <strong>Report Title</strong> <span class="text-danger">*</span>
                            </label>
                            <InputText @bind-Value="model.Title" 
                                      class="form-control form-control-lg" 
                                      placeholder="e.g., Parking slot damaged, Payment issue, etc."
                                      maxlength="200" />
                            <div class="d-flex justify-content-between">
                                <ValidationMessage For="@(() => model.Title)" class="text-danger" />
                                <small class="text-muted">@(model.Title?.Length ?? 0) / 200</small>
                            </div>
                        </div>

                        <!-- Content -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <strong>Detailed Description</strong> <span class="text-danger">*</span>
                            </label>
                            <InputTextArea @bind-Value="model.Content" 
                                          class="form-control" 
                                          rows="10"
                                          placeholder="Please provide as much detail as possible:
- What happened?
- When did it happen?
- Where did it happen?
- Vehicle plate number (if applicable)
- Parking slot number (if applicable)
- Any other relevant information" />
                            <div class="d-flex justify-content-between">
                                <ValidationMessage For="@(() => model.Content)" class="text-danger" />
                                <small class="text-muted">@(model.Content?.Length ?? 0) characters</small>
                            </div>
                        </div>

                        <!-- Tips Box -->
                        <div class="alert alert-success">
                            <h6><span class="oi oi-lightbulb"></span> <strong>Tips for writing effective reports:</strong></h6>
                            <ul class="mb-0">
                                <li>‚úÖ Be specific and detailed about the problem</li>
                                <li>‚úÖ Include date, time, and location information</li>
                                <li>‚úÖ Mention your vehicle plate number if relevant</li>
                                <li>‚úÖ Include parking slot number if applicable</li>
                                <li>‚úÖ Attach photos or documents if possible (coming soon)</li>
                                <li>‚ùå Avoid vague descriptions like "something wrong"</li>
                            </ul>
                        </div>

                        <!-- Preview Box -->
                        @if (!string.IsNullOrWhiteSpace(model.Title) && !string.IsNullOrWhiteSpace(model.Content))
                        {
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6><span class="oi oi-eye"></span> Preview</h6>
                                </div>
                                <div class="card-body">
                                    <h5>@model.Title</h5>
                                    <p class="mb-0" style="white-space: pre-wrap;">@model.Content</p>
                                </div>
                            </div>
                        }

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-secondary btn-lg" @onclick="Cancel" disabled="@isSubmitting">
                                <span class="oi oi-x"></span> Cancel
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg" disabled="@(isSubmitting || categories.Count == 0)">
                                @if (isSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span>Creating Report...</span>
                                }
                                else
                                {
                                    <span class="oi oi-check"></span>
                                    <span> Submit Report</span>
                                }
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>

            <!-- Additional Help Card -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6><span class="oi oi-question-mark"></span> Need help?</h6>
                    <p class="mb-0">
                        If you're experiencing an emergency situation, please contact our 24/7 hotline: 
                        <strong class="text-primary">1900-XXXX</strong>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ReportFormModel model = new ReportFormModel();
    private List<ReportCategory> categories = new List<ReportCategory>();
    private bool isLoadingCategories = true;
    private bool isSubmitting = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    private Guid currentCustomerId ;

    private ReportCategory? selectedCategory => 
        model.CategoryID != Guid.Empty 
            ? categories.FirstOrDefault(c => c.CategoryId == model.CategoryID) 
            : null;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
        currentCustomerId = await UserService.GetCurrentUserId();
    }


    private async Task LoadCategories()
    {
        isLoadingCategories = true;
        errorMessage = string.Empty;
        
        try
        {
            categories = await ReportService.GetCategoriesAsync();
            
            if (categories == null || categories.Count == 0)
            {
                errorMessage = "No categories available. Please try again later.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load categories: {ex.Message}";
            Console.WriteLine($"Error loading categories: {ex}");
        }
        finally
        {
            isLoadingCategories = false;
        }
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            var report = new CustomerReport
            {
                CustomerId = currentCustomerId,
                CategoryId = model.CategoryID,
                Title = model.Title,
                Content = model.Content,
                Priority = model.Priority
            };

            var result = await ReportService.CreateReportAsync(report);
            
            successMessage = "Report created successfully! Redirecting...";
            
            // Small delay to show success message
            await Task.Delay(1000);
            
            Navigation.NavigateTo($"/reports/{result.ReportId}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to create report: {ex.Message}";
            Console.WriteLine($"Error creating report: {ex}");
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        if (isSubmitting)
            return;

        Navigation.NavigateTo("/reports");
    }

    public class ReportFormModel
    {
        [Required(ErrorMessage = "Please select a category")]
        public Guid CategoryID { get; set; } = Guid.Empty;

        [Required(ErrorMessage = "Priority is required")]
        public string Priority { get; set; } = "Normal";

        [Required(ErrorMessage = "Title is required")]
        [StringLength(200, MinimumLength = 5, ErrorMessage = "Title must be between 5 and 200 characters")]
        public string Title { get; set; } = string.Empty;

        [Required(ErrorMessage = "Description is required")]
        [StringLength(5000, MinimumLength = 10, ErrorMessage = "Description must be between 10 and 5000 characters")]
        public string Content { get; set; } = string.Empty;
    }
}