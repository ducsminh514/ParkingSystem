@page "/staffslots"
@using ParkingSystem.Shared.Models
@using ParkingSystem.Shared.DTOs
@using ParkingSystem.Client.Services
@inject SlotService SlotService
@inject UserService UserService
@inject CustomerService CustomerService
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Xem Ch·ªó Tr·ªëng</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h3><i class="bi bi-p-square-fill"></i> Qu·∫£n L√Ω Ch·ªó ƒê·ªó Xe</h3>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        </div>
    }

    <!-- T·ªïng quan -->
    @if (overview != null)
    {
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title mb-0">T·ªïng S·ªë Ch·ªó</h6>
                                <h3 class="mb-0">@overview.TotalSlots</h3>
                            </div>
                            <i class="bi bi-grid-3x3-gap-fill" style="font-size: 2.5rem; opacity: 0.5;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title mb-0">Ch·ªó Tr·ªëng</h6>
                                <h3 class="mb-0">@overview.AvailableSlots</h3>
                            </div>
                            <i class="bi bi-check-circle-fill" style="font-size: 2.5rem; opacity: 0.5;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title mb-0">ƒê√£ S·ª≠ D·ª•ng</h6>
                                <h3 class="mb-0">@overview.OccupiedSlots</h3>
                            </div>
                            <i class="bi bi-x-circle-fill" style="font-size: 2.5rem; opacity: 0.5;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title mb-0">T·ª∑ L·ªá L·∫•p ƒê·∫ßy</h6>
                                <h3 class="mb-0">@overview.OccupancyRate%</h3>
                            </div>
                            <i class="bi bi-pie-chart-fill" style="font-size: 2.5rem; opacity: 0.5;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">ƒêang t·∫£i...</span>
            </div>
            <p class="mt-2">ƒêang t·∫£i d·ªØ li·ªáu ch·ªó ƒë·ªó xe...</p>
        </div>
    }
    else if ((isStaff && parkingAreas.Count == 0) || (!isStaff && customerParkingAreas.Count == 0))
    {
        <div class="text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
            <p class="text-muted mt-3">Ch∆∞a c√≥ ch·ªó ƒë·ªó xe n√†o trong h·ªá th·ªëng</p>
        </div>
    }
    else
    {
        @if (isStaff)
        {
            <!-- STAFF VIEW: Hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß th√¥ng tin -->
            @foreach (var area in parkingAreas)
            {
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="mb-0">
                                    <i class="bi bi-building"></i> @area.AreaName
                                </h5>
                            </div>
                            <div class="col-auto">
                                <span class="badge bg-success me-2">
                                    <i class="bi bi-check-circle"></i> Tr·ªëng: @area.AvailableSlots
                                </span>
                                <span class="badge bg-danger me-2">
                                    <i class="bi bi-x-circle"></i> ƒê√£ d√πng: @area.OccupiedSlots
                                </span>
                                <span class="badge bg-info">
                                    T·ª∑ l·ªá: @area.OccupancyRate%
                                </span>
                            </div>
                        </div>
                        <div class="progress mt-2" style="height: 8px;">
                            <div class="progress-bar bg-danger" 
                                 role="progressbar" 
                                 style="width: @(area.OccupancyRate)%"
                                 aria-valuenow="@area.OccupancyRate" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="parking-grid">
                            @foreach (var slot in area.Slots)
                            {
                                <div class="parking-slot @(slot.IsAvailable ? "available" : "occupied")"
                                     @onclick="() => OpenSlotModal(slot)"
                                     title="Click ƒë·ªÉ xem chi ti·∫øt">
                                    <div class="slot-icon">
                                        @if (slot.IsAvailable)
                                        {
                                            <i class="bi bi-p-square"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-car-front-fill"></i>
                                        }
                                    </div>
                                    <div class="slot-code">@slot.SlotCode</div>
                                    
                                    @if (!slot.IsAvailable && !string.IsNullOrEmpty(slot.VehiclePlateNumber))
                                    {
                                        <div class="slot-info">
                                            <small class="d-block text-truncate fw-bold">
                                                <i class="bi bi-credit-card-2-front"></i> @slot.VehiclePlateNumber
                                            </small>
                                            @if (!string.IsNullOrEmpty(slot.CustomerName))
                                            {
                                                <small class="d-block text-truncate">
                                                    <i class="bi bi-person"></i> @slot.CustomerName
                                                </small>
                                            }
                                            @if (slot.CheckInTime.HasValue)
                                            {
                                                <small class="d-block">
                                                    <i class="bi bi-clock"></i> @slot.ParkingDuration
                                                </small>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <!-- CUSTOMER VIEW: Ch·ªâ hi·ªÉn th·ªã tr·∫°ng th√°i slot -->
            @foreach (var area in customerParkingAreas)
            {
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="mb-0">
                                    <i class="bi bi-building"></i> @area.AreaName
                                </h5>
                            </div>
                            <div class="col-auto">
                                <span class="badge bg-success me-2">
                                    <i class="bi bi-check-circle"></i> Tr·ªëng: @area.AvailableSlots
                                </span>
                                <span class="badge bg-danger me-2">
                                    <i class="bi bi-x-circle"></i> ƒê√£ d√πng: @area.OccupiedSlots
                                </span>
                                <span class="badge bg-info">
                                    T·ª∑ l·ªá: @area.OccupancyRate%
                                </span>
                            </div>
                        </div>
                        <div class="progress mt-2" style="height: 8px;">
                            <div class="progress-bar bg-danger" 
                                 role="progressbar" 
                                 style="width: @(area.OccupancyRate)%"
                                 aria-valuenow="@area.OccupancyRate" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="parking-grid">
                            @foreach (var slot in area.Slots)
                            {
                                <div class="parking-slot @(slot.IsAvailable ? "available" : "occupied")"
                                     @onclick="() => OpenCustomerSlotModal(slot)"
                                     title="Click ƒë·ªÉ xem chi ti·∫øt">
                                    <div class="slot-icon">
                                        @if (slot.IsAvailable)
                                        {
                                            <i class="bi bi-p-square"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-car-front-fill"></i>
                                        }
                                    </div>
                                    <div class="slot-code">@slot.SlotCode</div>
                                    
                                    @if (!slot.IsAvailable)
                                    {
                                        @if (slot.IsMySlot)
                                        {
                                            <!-- Slot c·ªßa ch√≠nh customer n√†y - Hi·ªÉn th·ªã th√¥ng tin ƒë·∫ßy ƒë·ªß -->
                                            <div class="slot-info">
                                                <small class="d-block text-truncate fw-bold">
                                                    <i class="bi bi-credit-card-2-front"></i> @slot.VehiclePlateNumber
                                                </small>
                                                @if (slot.CheckInTime.HasValue)
                                                {
                                                    <small class="d-block">
                                                        <i class="bi bi-clock"></i> @slot.ParkingDuration
                                                    </small>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <!-- Slot c·ªßa ng∆∞·ªùi kh√°c - Ch·ªâ hi·ªÉn th·ªã "ƒê√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω" -->
                                            <div class="slot-info">
                                                <small class="d-block text-center text-muted">
                                                    <i class="bi bi-lock-fill"></i> ƒê√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω
                                                </small>
                                            </div>
                                        }
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        }
    }
</div>

<!-- Modal Chi Ti·∫øt & ƒêƒÉng K√Ω Slot -->
<div class="modal fade" id="slotModal" tabindex="-1" aria-labelledby="slotModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        @if (isStaff && selectedSlot != null)
        {
            <!-- STAFF MODAL: Hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß th√¥ng tin -->
            <div class="modal-content">
                <div class="modal-header @(selectedSlot.IsAvailable ? "bg-success" : "bg-danger") text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-info-circle"></i> Chi Ti·∫øt Ch·ªó ƒê·ªó - @selectedSlot.SlotCode
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    @if (selectedSlot.IsAvailable)
                    {
                        <!-- Slot tr·ªëng - Form ƒëƒÉng k√Ω cho Staff -->
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill"></i> Ch·ªó ƒë·ªó n√†y ƒëang tr·ªëng v√† c√≥ th·ªÉ s·ª≠ d·ª•ng
                        </div>
                        
                        <h6 class="mb-3"><i class="bi bi-clipboard-plus"></i> ƒêƒÉng K√Ω Ch·ªó ƒê·ªó</h6>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">H·ªç T√™n Kh√°ch H√†ng</label>
                                <input type="text" class="form-control" @bind="registrationForm.CustomerName" placeholder="Nh·∫≠p h·ªç t√™n" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">S·ªë ƒêi·ªán Tho·∫°i</label>
                                <input type="tel" class="form-control" @bind="registrationForm.CustomerPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Bi·ªÉn S·ªë Xe</label>
                                <input type="text" class="form-control" @bind="registrationForm.PlateNumber" placeholder="Nh·∫≠p bi·ªÉn s·ªë" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Lo·∫°i Xe</label>
                                <select class="form-select" @bind="registrationForm.VehicleType">
                                    <option value="">-- Ch·ªçn lo·∫°i xe --</option>
                                    <option value="Xe m√°y">Xe m√°y</option>
                                    <option value="√î t√¥">√î t√¥</option>
                                    <option value="Xe ƒë·∫°p">Xe ƒë·∫°p</option>
                                    <option value="Xe t·∫£i">Xe t·∫£i</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Email (t√πy ch·ªçn)</label>
                                <input type="email" class="form-control" @bind="registrationForm.CustomerEmail" placeholder="Nh·∫≠p email" />
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(registrationError))
                        {
                            <div class="alert alert-danger mt-3">
                                <i class="bi bi-exclamation-triangle-fill"></i> @registrationError
                            </div>
                        }
                    }
                    else
                    {
                        <!-- Slot ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng - Staff xem ƒë∆∞·ª£c th√¥ng tin ƒë·∫ßy ƒë·ªß -->
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle-fill"></i> Ch·ªó ƒë·ªó n√†y ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="info-item">
                                    <label class="text-muted small">Bi·ªÉn S·ªë Xe</label>
                                    <div class="fw-bold fs-5">
                                        <i class="bi bi-credit-card-2-front text-primary"></i> @selectedSlot.VehiclePlateNumber
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <label class="text-muted small">Lo·∫°i Xe</label>
                                    <div class="fw-bold">
                                        <i class="bi bi-car-front text-primary"></i> @(selectedSlot.VehicleType ?? "N/A")
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <label class="text-muted small">Kh√°ch H√†ng</label>
                                    <div class="fw-bold">
                                        <i class="bi bi-person text-success"></i> @(selectedSlot.CustomerName ?? "N/A")
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <label class="text-muted small">S·ªë ƒêi·ªán Tho·∫°i</label>
                                    <div class="fw-bold">
                                        <i class="bi bi-telephone text-success"></i> @(selectedSlot.CustomerPhone ?? "N/A")
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <label class="text-muted small">Th·ªùi Gian V√†o</label>
                                    <div class="fw-bold">
                                        <i class="bi bi-clock-history text-info"></i> @(selectedSlot.CheckInTime?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <label class="text-muted small">Th·ªùi Gian ƒê·ªó</label>
                                    <div class="fw-bold">
                                        <i class="bi bi-hourglass-split text-warning"></i> @(selectedSlot.ParkingDuration ?? "N/A")
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg"></i> ƒê√≥ng
                    </button>
                    @if (selectedSlot.IsAvailable)
                    {
                        <button type="button" class="btn btn-success" @onclick="SubmitRegistration" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>ƒêang x·ª≠ l√Ω...</span>
                            }
                            else
                            {
                                <i class="bi bi-check-lg"></i>
                                <span>ƒêƒÉng K√Ω</span>
                            }
                        </button>
                    }
                    else
                    {
                        <button type="button" class="btn btn-danger" @onclick="HandleCheckOut" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>ƒêang x·ª≠ l√Ω...</span>
                            }
                            else
                            {
                                <i class="bi bi-box-arrow-right"></i>
                                <span>Check Out</span>
                            }
                        </button>
                    }
                </div>
            </div>
        }
        else if (!isStaff && selectedCustomerSlot != null)
        {
            <!-- CUSTOMER MODAL: Ch·ªâ hi·ªÉn th·ªã tr·∫°ng th√°i, kh√¥ng c√≥ th√¥ng tin c√° nh√¢n -->
            <div class="modal-content">
                <div class="modal-header @(selectedCustomerSlot.IsAvailable ? "bg-success" : "bg-danger") text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-info-circle"></i> Chi Ti·∫øt Ch·ªó ƒê·ªó - @selectedCustomerSlot.SlotCode
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    @if (selectedCustomerSlot.IsAvailable)
                    {
                        <!-- Slot tr·ªëng - Form ƒëƒÉng k√Ω cho Customer v·ªõi auto-fill -->
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill"></i> Ch·ªó ƒë·ªó n√†y ƒëang tr·ªëng v√† c√≥ th·ªÉ ƒëƒÉng k√Ω
                        </div>
                        
                        <h6 class="mb-3"><i class="bi bi-clipboard-plus"></i> ƒêƒÉng K√Ω Ch·ªó ƒê·ªó</h6>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">H·ªç T√™n</label>
                                <input type="text" class="form-control" @bind="registrationForm.CustomerName" placeholder="Nh·∫≠p h·ªç t√™n" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">S·ªë ƒêi·ªán Tho·∫°i</label>
                                <input type="tel" class="form-control" @bind="registrationForm.CustomerPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" />
                            </div>
                            
                            @if (customerVehicles.Count > 0)
                            {
                                <div class="col-12">
                                    <div class="alert alert-success">
                                        <i class="bi bi-car-front-fill"></i> <strong>Xe c·ªßa b·∫°n</strong> - Ch·ªçn nhanh t·ª´ danh s√°ch xe ƒë√£ ƒëƒÉng k√Ω
                                    </div>
                                    <label class="form-label fw-bold text-primary">
                                        <i class="bi bi-list-check"></i> Ch·ªçn Xe C√≥ S·∫µn
                                    </label>
                                    <select class="form-select form-select-lg" @onchange="OnVehicleSelected">
                                        <option value="">-- Ch·ªçn xe ho·∫∑c nh·∫≠p xe m·ªõi b√™n d∆∞·ªõi --</option>
                                        @foreach (var vehicle in customerVehicles)
                                        {
                                            <option value="@vehicle.VehicleId">
                                                üöó @vehicle.PlateNumber - @vehicle.VehicleType
                                            </option>
                                        }
                                    </select>
                                    <small class="text-muted mt-1 d-block">
                                        <i class="bi bi-info-circle"></i> Ch·ªçn xe ƒë√£ ƒëƒÉng k√Ω ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin
                                    </small>
                                </div>
                                <div class="col-12">
                                    <div class="text-center my-2">
                                        <small class="text-muted">
                                            <i class="bi bi-arrow-down-short"></i> ho·∫∑c nh·∫≠p th√¥ng tin xe m·ªõi <i class="bi bi-arrow-down-short"></i>
                                        </small>
                                    </div>
                                </div>
                            }
                            
                            <div class="col-md-6">
                                <label class="form-label">Bi·ªÉn S·ªë Xe</label>
                                <input type="text" class="form-control" @bind="registrationForm.PlateNumber" placeholder="Nh·∫≠p bi·ªÉn s·ªë" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Lo·∫°i Xe</label>
                                <select class="form-select" @bind="registrationForm.VehicleType">
                                    <option value="">-- Ch·ªçn lo·∫°i xe --</option>
                                    <option value="Xe m√°y">Xe m√°y</option>
                                    <option value="√î t√¥">√î t√¥</option>
                                    <option value="Xe ƒë·∫°p">Xe ƒë·∫°p</option>
                                    <option value="Xe t·∫£i">Xe t·∫£i</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Email (t√πy ch·ªçn)</label>
                                <input type="email" class="form-control" @bind="registrationForm.CustomerEmail" placeholder="Nh·∫≠p email" />
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle"></i> Th√¥ng tin c√° nh√¢n ƒë√£ ƒë∆∞·ª£c t·ª± ƒë·ªông ƒëi·ªÅn. B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a n·∫øu c·∫ßn.
                        </div>

                        @if (!string.IsNullOrEmpty(registrationError))
                        {
                            <div class="alert alert-danger mt-3">
                                <i class="bi bi-exclamation-triangle-fill"></i> @registrationError
                            </div>
                        }
                    }
                    else
                    {
                        <!-- Slot ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω -->
                        @if (selectedCustomerSlot.IsMySlot)
                        {
                            <!-- Slot c·ªßa ch√≠nh customer n√†y - Hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß th√¥ng tin -->
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle-fill"></i> ƒê√¢y l√† ch·ªó ƒë·ªó m√† b·∫°n ƒë√£ ƒëƒÉng k√Ω
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <label class="text-muted small">Bi·ªÉn S·ªë Xe</label>
                                        <div class="fw-bold fs-5">
                                            <i class="bi bi-credit-card-2-front text-primary"></i> @selectedCustomerSlot.VehiclePlateNumber
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <label class="text-muted small">Lo·∫°i Xe</label>
                                        <div class="fw-bold">
                                            <i class="bi bi-car-front text-primary"></i> @(selectedCustomerSlot.VehicleType ?? "N/A")
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <label class="text-muted small">S·ªë ƒêi·ªán Tho·∫°i</label>
                                        <div class="fw-bold">
                                            <i class="bi bi-telephone text-success"></i> @(selectedCustomerSlot.CustomerPhone ?? "N/A")
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <label class="text-muted small">Th·ªùi Gian V√†o</label>
                                        <div class="fw-bold">
                                            <i class="bi bi-clock-history text-info"></i> @(selectedCustomerSlot.CheckInTime?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <label class="text-muted small">Th·ªùi Gian ƒê·ªó</label>
                                        <div class="fw-bold">
                                            <i class="bi bi-hourglass-split text-warning"></i> @(selectedCustomerSlot.ParkingDuration ?? "N/A")
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <!-- Slot c·ªßa ng∆∞·ªùi kh√°c - KH√îNG hi·ªÉn th·ªã th√¥ng tin -->
                            <div class="alert alert-danger">
                                <i class="bi bi-lock-fill"></i> Ch·ªó ƒë·ªó n√†y ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω b·ªüi ng∆∞·ªùi kh√°c
                            </div>
                            
                            <div class="text-center py-4">
                                <i class="bi bi-shield-lock" style="font-size: 4rem; color: #6c757d;"></i>
                                <p class="text-muted mt-3">Th√¥ng tin chi ti·∫øt ch·ªâ d√†nh cho ch·ªß s·ªü h·ªØu v√† nh√¢n vi√™n qu·∫£n l√Ω</p>
                            </div>
                        }
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg"></i> ƒê√≥ng
                    </button>
                    @if (selectedCustomerSlot.IsAvailable)
                    {
                        <button type="button" class="btn btn-success" @onclick="SubmitRegistration" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>ƒêang x·ª≠ l√Ω...</span>
                            }
                            else
                            {
                                <i class="bi bi-check-lg"></i>
                                <span>ƒêƒÉng K√Ω</span>
                            }
                        </button>
                    }
                    else if (selectedCustomerSlot.IsMySlot)
                    {
                        <button type="button" class="btn btn-danger" @onclick="HandleCheckOut" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>ƒêang x·ª≠ l√Ω...</span>
                            }
                            else
                            {
                                <i class="bi bi-box-arrow-right"></i>
                                <span>Check Out</span>
                            }
                        </button>
                    }
                </div>
            </div>
        }
    </div>
</div>

<!-- Success Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check-circle-fill me-2"></i>
                <span id="toastMessage">Thao t√°c th√†nh c√¥ng!</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<style>
    /* ============================================ */
    /*         PARKING SLOTS MODERN STYLES         */
    /* ============================================ */

    /* Grid layout cho parking slots */
    .parking-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 1.25rem;
        padding: 1rem 0.5rem;
    }



    /* Style cho m·ªói slot */
    .parking-slot {
        min-height: 200px;
        border: none;
        border-radius: 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        padding: 1.25rem 1rem;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    }

    /* Glow effect on hover */
    .parking-slot::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
        opacity: 0;
        transition: opacity 0.4s ease;
    }

    .parking-slot:hover::before {
        opacity: 1;
    }

    .parking-slot:hover {
        transform: translateY(-8px) scale(1.03);
        box-shadow: 0 20px 35px rgba(0,0,0,0.15);
    }

    /* Slot tr·ªëng - gradient xanh l√° hi·ªán ƒë·∫°i */
    .parking-slot.available {
        background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 50%, #6EE7B7 100%);
        border: 2px solid #10B981;
        position: relative;
    }

    .parking-slot.available::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #10B981, #059669);
    }

    .parking-slot.available .slot-icon {
        color: #059669;
        filter: drop-shadow(0 2px 4px rgba(16, 185, 129, 0.3));
    }

    /* Slot ƒë√£ s·ª≠ d·ª•ng - gradient ƒë·ªè hi·ªán ƒë·∫°i */
    .parking-slot.occupied {
        background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 50%, #FCA5A5 100%);
        border: 2px solid #EF4444;
        position: relative;
    }

    .parking-slot.occupied::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #EF4444, #DC2626);
    }

    .parking-slot.occupied .slot-icon {
        color: #DC2626;
        filter: drop-shadow(0 2px 4px rgba(239, 68, 68, 0.3));
        animation: pulse 2s infinite;
    }

    /* Icon trong slot */
    .slot-icon {
        font-size: 2.75rem;
        margin-bottom: 0.75rem;
        transition: all 0.3s ease;
    }

    .parking-slot:hover .slot-icon {
        transform: scale(1.1) rotate(5deg);
    }

    /* M√£ slot */
    .slot-code {
        font-weight: 700;
        font-size: 1.15rem;
        text-align: center;
        margin-bottom: 0.5rem;
        color: #1F2937;
        font-family: 'Poppins', sans-serif;
        letter-spacing: 0.5px;
    }

    /* Th√¥ng tin trong slot */
    .slot-info {
        width: 100%;
        margin-top: auto;
        padding-top: 0.75rem;
        border-top: 2px solid rgba(0,0,0,0.1);
        font-size: 0.8rem;
        line-height: 1.5;
    }

    .slot-info small {
        color: #374151;
        font-weight: 500;
    }

    /* Info item trong modal */
    .info-item {
        padding: 1rem 1.25rem;
        background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%);
        border-radius: 0.75rem;
        margin-bottom: 0.75rem;
        border-left: 4px solid #4F46E5;
        transition: all 0.3s ease;
    }

    .info-item:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .info-item label {
        margin-bottom: 0.5rem;
        display: block;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.05em;
    }

    /* Overview cards animation */
    .card.bg-primary,
    .card.bg-success,
    .card.bg-danger,
    .card.bg-info {
        animation: fadeInUp 0.6s ease-in-out;
        transition: all 0.3s ease;
    }

    .card.bg-primary:hover,
    .card.bg-success:hover,
    .card.bg-danger:hover,
    .card.bg-info:hover {
        transform: translateY(-5px) scale(1.02);
    }

    .card.bg-primary:nth-child(1) { animation-delay: 0.1s; }
    .card.bg-success:nth-child(2) { animation-delay: 0.2s; }
    .card.bg-danger:nth-child(3) { animation-delay: 0.3s; }
    .card.bg-info:nth-child(4) { animation-delay: 0.4s; }

    /* Animation cho c√°c th·∫ª card */
    .card {
        animation: fadeInUp 0.6s ease-in-out;
    }

    /* Modal animation */
    .modal.show {
        animation: fadeIn 0.3s ease-in-out;
    }


    /* Page title styling */
    h3 {
        font-weight: 700;
        color: #1F2937;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    h3 i {
        background: linear-gradient(135deg, #4F46E5, #7C3AED);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* Card header improvements */
    .card-header {
        background: linear-gradient(135deg, #FFFFFF 0%, #F9FAFB 100%);
        border-bottom: 2px solid #E5E7EB;
    }

    .card-header h5 {
        font-weight: 600;
        color: #1F2937;
    }

    /* Badge improvements */
    .badge {
        font-weight: 600;
        padding: 0.5rem 0.85rem;
        font-size: 0.85rem;
    }

    /* Progress bar styling */
    .progress {
        height: 8px;
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Button hover effects */
    .btn {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn:active {
        transform: scale(0.97);
    }

    /* Loading spinner improvement */
    .spinner-border {
        border-width: 0.2em;
    }

    /* Empty state styling */
    .text-center.py-5 i.bi-inbox {
        animation: float 3s ease-in-out infinite;
    }

</style>

@code {
    private List<ParkingAreaDto> parkingAreas = new();
    private List<CustomerParkingAreaDto> customerParkingAreas = new();
    private ParkingOverviewDto? overview;
    private bool isLoading = true;
    private string errorMessage = string.Empty;

    // User info
    private UserInfo? currentUser = null;
    private bool isStaff = false;

    // Modal state
    private ParkingSlotDto? selectedSlot = null;
    private CustomerParkingSlotDto? selectedCustomerSlot = null;
    private string registrationError = string.Empty;
    private bool isSubmitting = false;
    
    // Registration form
    private RegistrationFormModel registrationForm = new();
    private List<ParkingSystem.Shared.Models.Vehicle> customerVehicles = new();

    protected override async Task OnInitializedAsync()
    {
        // Get current user info
        currentUser = await UserService.GetCurrentUser();
        isStaff = currentUser?.UserType == "Staff";

        // Register real-time event handlers
        SlotService.OnSlotUpdated += HandleSlotUpdated;
        SlotService.OnParkingRegistered += HandleParkingRegistered;
        SlotService.OnSlotCheckedOut += HandleSlotCheckedOut;

        await LoadParkingData();
    }

    private void HandleSlotUpdated(ParkingSlotDto updatedSlot)
    {
        // Find and update the slot in the current data
        foreach (var area in parkingAreas)
        {
            var slot = area.Slots.FirstOrDefault(s => s.SlotId == updatedSlot.SlotId);
            if (slot != null)
            {
                // Update slot properties
                slot.Status = updatedSlot.Status;
                slot.VehiclePlateNumber = updatedSlot.VehiclePlateNumber;
                slot.VehicleType = updatedSlot.VehicleType;
                slot.CustomerName = updatedSlot.CustomerName;
                slot.CustomerPhone = updatedSlot.CustomerPhone;
                slot.CheckInTime = updatedSlot.CheckInTime;
                slot.CurrentRegistrationId = updatedSlot.CurrentRegistrationId;

                // Update area statistics
                area.AvailableSlots = area.Slots.Count(s => s.IsAvailable);
                area.OccupiedSlots = area.Slots.Count(s => !s.IsAvailable);
                
                InvokeAsync(StateHasChanged);
                break;
            }
        }

        // Update overview
        if (overview != null)
        {
            overview.AvailableSlots = parkingAreas.Sum(a => a.AvailableSlots);
            overview.OccupiedSlots = parkingAreas.Sum(a => a.OccupiedSlots);
            overview.OccupancyRate = overview.TotalSlots > 0
                ? Math.Round((double)overview.OccupiedSlots / overview.TotalSlots * 100, 1)
                : 0;
        }

        InvokeAsync(StateHasChanged);
    }

    private void HandleParkingRegistered(RegisterParkingResponse response)
    {
        if (response.Success && response.UpdatedSlot != null)
        {
            HandleSlotUpdated(response.UpdatedSlot);
        }
    }

    private async void HandleSlotCheckedOut(Guid slotId)
    {
        // Refresh the specific slot or reload all data
        await LoadParkingData();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadParkingData()
    {
        try
        {
            isLoading = true;
            errorMessage = string.Empty;

            // Ki·ªÉm tra k·∫øt n·ªëi SignalR
            if (!SlotService.IsConnected)
            {
                errorMessage = "ƒêang k·∫øt n·ªëi t·ªõi server...";
                StateHasChanged();
                
                // Th·ª≠ k·∫øt n·ªëi l·∫°i
                bool reconnected = await SlotService.TryReconnectAsync();
                if (!reconnected)
                {
                    errorMessage = "Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server. Vui l√≤ng ki·ªÉm tra server ƒë√£ ch·∫°y ch∆∞a v√† th·ª≠ l·∫°i.";
                    return;
                }
                
                errorMessage = string.Empty;
            }

            // T·∫£i d·ªØ li·ªáu kh√°c nhau t√πy theo role
            if (isStaff)
            {
                // Staff: L·∫•y ƒë·∫ßy ƒë·ªß th√¥ng tin
                var overviewTask = SlotService.GetParkingOverviewAsync();
                var areasTask = SlotService.GetSlotsByAreaAsync();

                await Task.WhenAll(overviewTask, areasTask);

                overview = await overviewTask;
                parkingAreas = await areasTask;
            }
            else
            {
                // Customer: L·∫•y th√¥ng tin v·ªõi chi ti·∫øt c·ªßa slot c·ªßa ch√≠nh h·ªç
                if (currentUser != null)
                {
                    var overviewTask = SlotService.GetParkingOverviewForCustomerAsync();
                    var areasTask = SlotService.GetSlotsByAreaForCustomerAsync(currentUser.UserId);

                    await Task.WhenAll(overviewTask, areasTask);

                    overview = await overviewTask;
                    customerParkingAreas = await areasTask;
                }
                else
                {
                    errorMessage = "Kh√¥ng th·ªÉ x√°c ƒë·ªãnh th√¥ng tin ng∆∞·ªùi d√πng. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.";
                }
            }
        }
        catch (InvalidOperationException ex) when (ex.Message.Contains("SignalR"))
        {
            errorMessage = "M·∫•t k·∫øt n·ªëi server. Vui l√≤ng ki·ªÉm tra server v√† nh·∫•n 'L√†m m·ªõi' ƒë·ªÉ th·ª≠ l·∫°i.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RefreshSlots()
    {
        await LoadParkingData();
    }

    private async Task OpenSlotModal(ParkingSlotDto slot)
    {
        selectedSlot = slot;
        registrationError = string.Empty;
        
        // Reset form n·∫øu slot tr·ªëng
        if (slot.IsAvailable)
        {
            registrationForm = new RegistrationFormModel();
            
            // N·∫øu l√† customer, auto-fill th√¥ng tin
            if (!isStaff && currentUser != null)
            {
                registrationForm.CustomerName = currentUser.FullName;
                registrationForm.CustomerPhone = currentUser.Phone ?? string.Empty;
                registrationForm.CustomerEmail = currentUser.Email ?? string.Empty;
            }
        }

        // Show modal using Bootstrap
        await JSRuntime.InvokeVoidAsync("slotHelpers.showModal", "slotModal");
    }

    private async Task OpenCustomerSlotModal(CustomerParkingSlotDto slot)
    {
        selectedCustomerSlot = slot;
        registrationError = string.Empty;
        
        // Reset v√† auto-fill form n·∫øu slot tr·ªëng
        if (slot.IsAvailable)
        {
            registrationForm = new RegistrationFormModel();
            
            // Auto-fill th√¥ng tin customer hi·ªán t·∫°i
            if (currentUser != null)
            {
                registrationForm.CustomerName = currentUser.FullName;
                registrationForm.CustomerPhone = currentUser.Phone ?? string.Empty;
                registrationForm.CustomerEmail = currentUser.Email ?? string.Empty;
                
                // Load danh s√°ch xe c·ªßa customer
                await LoadCustomerVehicles();
            }
        }

        // Show modal using Bootstrap
        await JSRuntime.InvokeVoidAsync("slotHelpers.showModal", "slotModal");
    }

    private async Task LoadCustomerVehicles()
    {
        if (currentUser == null) return;
        
        try
        {
            customerVehicles = await CustomerService.GetMyVehicles(currentUser.UserId);
        }
        catch (Exception)
        {
            // N·∫øu l·ªói, ƒë·ªÉ list r·ªóng v√† user c√≥ th·ªÉ nh·∫≠p m·ªõi
            customerVehicles = new List<ParkingSystem.Shared.Models.Vehicle>();
        }
    }

    private void OnVehicleSelected(ChangeEventArgs e)
    {
        var vehicleIdStr = e.Value?.ToString();
        if (string.IsNullOrEmpty(vehicleIdStr))
        {
            // Clear vehicle fields if "none" selected
            registrationForm.PlateNumber = string.Empty;
            registrationForm.VehicleType = string.Empty;
            return;
        }

        if (Guid.TryParse(vehicleIdStr, out var vehicleId))
        {
            var selectedVehicle = customerVehicles.FirstOrDefault(v => v.VehicleId == vehicleId);
            if (selectedVehicle != null)
            {
                registrationForm.PlateNumber = selectedVehicle.PlateNumber ?? string.Empty;
                registrationForm.VehicleType = selectedVehicle.VehicleType ?? string.Empty;
            }
        }
    }

    private async Task CloseModal()
    {
        await JSRuntime.InvokeVoidAsync("slotHelpers.hideModal", "slotModal");
        selectedSlot = null;
        selectedCustomerSlot = null;
        registrationError = string.Empty;
    }

    private async Task SubmitRegistration()
    {
        try
        {
            isSubmitting = true;
            registrationError = string.Empty;

            // Validate form
            if (string.IsNullOrWhiteSpace(registrationForm.CustomerName))
            {
                registrationError = "Vui l√≤ng nh·∫≠p h·ªç t√™n";
                return;
            }

            if (string.IsNullOrWhiteSpace(registrationForm.CustomerPhone))
            {
                registrationError = "Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i";
                return;
            }

            if (string.IsNullOrWhiteSpace(registrationForm.PlateNumber))
            {
                registrationError = "Vui l√≤ng nh·∫≠p bi·ªÉn s·ªë xe";
                return;
            }

            if (string.IsNullOrWhiteSpace(registrationForm.VehicleType))
            {
                registrationError = "Vui l√≤ng ch·ªçn lo·∫°i xe";
                return;
            }

            // Ki·ªÉm tra k·∫øt n·ªëi tr∆∞·ªõc khi ƒëƒÉng k√Ω
            if (!SlotService.IsConnected)
            {
                registrationError = "ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i server...";
                StateHasChanged();
                
                bool reconnected = await SlotService.TryReconnectAsync();
                if (!reconnected)
                {
                    registrationError = "Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server. Vui l√≤ng ki·ªÉm tra server ƒë√£ ch·∫°y ch∆∞a.";
                    return;
                }
            }

            // Get SlotId from appropriate slot object
            Guid slotId;
            string slotCode;
            
            if (isStaff && selectedSlot != null)
            {
                slotId = selectedSlot.SlotId;
                slotCode = selectedSlot.SlotCode;
            }
            else if (!isStaff && selectedCustomerSlot != null)
            {
                slotId = selectedCustomerSlot.SlotId;
                slotCode = selectedCustomerSlot.SlotCode;
            }
            else
            {
                registrationError = "Kh√¥ng t√¨m th·∫•y th√¥ng tin slot";
                return;
            }

            // Call API to register parking
            var request = new RegisterParkingRequest
            {
                SlotId = slotId,
                CustomerName = registrationForm.CustomerName,
                CustomerPhone = registrationForm.CustomerPhone,
                CustomerEmail = registrationForm.CustomerEmail,
                PlateNumber = registrationForm.PlateNumber,
                VehicleType = registrationForm.VehicleType,
                CustomerId = !isStaff && currentUser != null ? currentUser.UserId : null  // Pass CustomerId if customer
            };

            var response = await SlotService.RegisterParkingAsync(request);

            if (response.Success)
            {
                // Show success message
                await ShowToast($"ƒêƒÉng k√Ω th√†nh c√¥ng cho ch·ªó ƒë·ªó {slotCode}!");
                
                // Close modal
                await CloseModal();
                
                // Refresh data
                await RefreshSlots();
            }
            else
            {
                registrationError = response.Message;
            }
        }
        catch (InvalidOperationException ex) when (ex.Message.Contains("SignalR"))
        {
            registrationError = "M·∫•t k·∫øt n·ªëi server. Vui l√≤ng ki·ªÉm tra server v√† th·ª≠ l·∫°i.";
        }
        catch (Exception ex)
        {
            registrationError = $"L·ªói khi ƒëƒÉng k√Ω: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task HandleCheckOut()
    {
        // Get registration ID from appropriate slot object
        Guid? registrationId = null;
        string? vehiclePlate = null;

        if (isStaff && selectedSlot?.CurrentRegistrationId != null)
        {
            registrationId = selectedSlot.CurrentRegistrationId;
            vehiclePlate = selectedSlot.VehiclePlateNumber;
        }
        else if (!isStaff && selectedCustomerSlot?.CurrentRegistrationId != null)
        {
            registrationId = selectedCustomerSlot.CurrentRegistrationId;
            vehiclePlate = selectedCustomerSlot.VehiclePlateNumber;
        }

        if (registrationId == null)
        {
            await ShowToast("Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒëƒÉng k√Ω", false);
            return;
        }

        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"B·∫°n c√≥ ch·∫Øc mu·ªën check out cho xe {vehiclePlate}?");

        if (!confirmed)
            return;

        try
        {
            isSubmitting = true;

            var request = new CheckOutRequest
            {
                RegistrationId = registrationId.Value,
                PaymentAmount = 50000, // TODO: Calculate based on duration
                PaymentMethod = "Cash"
            };

            var response = await SlotService.CheckOutAsync(request);

            if (response.Success)
            {
                await ShowToast($"Check out th√†nh c√¥ng! Th·ªùi gian: {response.Duration?.ToString(@"hh\:mm")}");
                await CloseModal();
                await RefreshSlots();
            }
            else
            {
                await ShowToast(response.Message, false);
            }
        }
        catch (Exception ex)
        {
            await ShowToast($"L·ªói: {ex.Message}", false);
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task ShowToast(string message, bool success = true)
    {
        await JSRuntime.InvokeVoidAsync("slotHelpers.showToast", message, success);
    }

    // Form model cho ƒëƒÉng k√Ω
    private class RegistrationFormModel
    {
        public string CustomerName { get; set; } = string.Empty;
        public string CustomerPhone { get; set; } = string.Empty;
        public string CustomerEmail { get; set; } = string.Empty;
        public string PlateNumber { get; set; } = string.Empty;
        public string VehicleType { get; set; } = string.Empty;
    }

    public void Dispose()
    {
        // Unregister event handlers to prevent memory leaks
        SlotService.OnSlotUpdated -= HandleSlotUpdated;
        SlotService.OnParkingRegistered -= HandleParkingRegistered;
        SlotService.OnSlotCheckedOut -= HandleSlotCheckedOut;
    }
}
